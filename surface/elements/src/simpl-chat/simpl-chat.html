<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<polymer-element name="simpl-chat">
	<template>
		<style>
			:host {
				display: block;
			}
			paper-button /deep/ .button-content {
				padding: 0.5em 0.5em;
			}
			paper-button {
				max-width: 100px;
			}
			:host /deep/ xaction-button /deep/ .button-content {
				width: 120px;
				font-size: 12px;
				padding: 0.5em 0.5em;
			}
			simpl-row {
				margin-bottom: 12px;
			}
			core-icon.small {
				width: 16px;
				height: 16px;
			}
			core-icon.big {
				width: 24px;
				height: 24px;
			}
			simpl-panel /deep/ #panelContent {
				min-height: 400px;
				padding: 10px 5px 5px 5px !important;
			}
			.small-input {
				padding: 3px;
				margin-right: 2px;
				max-width: 50px;
				border-radius: 3px;
				border: 1px solid #CCC;
				background-image: none;
			}
			.name-column {
				float: left;
				width: 25%;
				padding: 2px;
			}
			.message-column {
				float: left;
				width: 60%;
				padding: 2px;
				word-wrap: break-word;
			}
			.timestamp-column {
				float: left;
				right: 0px;
				margin-right: 0px;
				text-align: center;
				font-size: 8px;
				font-weight: lighter;
				width: 15%;
				padding: 2px;
				background-color: #F2F2F2;
				color: gray;
			}
			#messagesBox {
				border: 0px solid lightgray;
				overflow-y: auto;
				min-height: 100px;
				font-size: 12px;
			}
			ol {
				list-style: none;
				margin: 0px;
				padding: 0px;
			}
			li {
				float: left;
				display: inline;
				border-bottom: 1px solid #F2F2F2;
				width: 100%;
				height: 100%;
				padding-bottom: 0px;
			}
			core-toolbar.core-narrow /deep/ #topBar.toolbar-tools {
				align-items: baseline;
			}
			core-toolbar.core-narrow {
				height: 38px;
				background: #f6f6f6;
			}
			core-item {
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
			}
			.dropdown.colored {
				border-radius: 3px;
				color: #000;
				//border: 1px solid #0f9d58;
				border: 1px solid #ccc;
				//background-color: #b7e1cd;
				background-color: #eee;
			}

		</style>


		<simpl-websocket id="websocket" namespace="tutorials" routeSpec="xmpp.camel" service="xmpp" connected="{{connected}}" recvMessage="{{recvMessage}}" autoConnect="{{autoConnect}}"> </simpl-websocket>
		<simpl-panel bgcolor="black" heading="~ Simpl Chat" collapsable="true" collapsed="false">
			<simpl-row>
				<template if="{{!connected && !(isAddUserFormActive||isAddGroupFormActive)}}">
					{{'chat.login'|tr}}:
					<input class="small-input" type="text" id="userName" value="{{user.name}}" /> {{'data.user.password'|tr}}:
					<input class="small-input" type="text" id="password" value="{{user.password}}" />
					<paper-button raised on-tap="{{connect}}" flex>
						<core-icon class="small" icon="communication:chat"></core-icon>{{'chat.connectButton'|tr}}</paper-button>
				</template>
			</simpl-row>
			<template if="{{connected && !(isAddUserFormActive||isAddGroupFormActive)}}">
				<simpl-row>
					<core-toolbar flex class="core-narrow">
						<core-icon-button on-tap="{{disconnect}}" icon="cloud-off"></core-icon-button>
						<core-icon-button icon="account-circle">{{user.name}}</core-icon-button>
						<core-menu-button>
							<core-icon-button icon="menu"></core-icon-button>
							<core-dropdown class="dropdown colored">
								<core-menu>
									<core-item on-tap="{{showAddUserForm}}" icon="add">{{'chat.add_contact'|tr}}</core-item>
									<!--core-item on-tap="{{showAddGroupForm}}" icon="add-circle">{{'chat.add_group'|tr}}</core-item-->
								</core-menu>
							</core-dropdown>
						</core-menu-button>

						<span style="color:red;">{{chatState}}</span>
					</core-toolbar>
				</simpl-row>
				<simpl-row>
					{{'chat.participant'|tr}}:
					<select id="participant">
						<template repeat="{{entry in rosterEntries}}">
							<option value="{{entry.username}}">{{entry.username}}</option>
						</template>
					</select>
				</simpl-row>
				<simpl-row>
					<input-field flex type="text" name="" id="messageInput" on-keyup="{{chatEventListener}}" on-keydown="{{onMessageKeydown}}" disabled?="{{!connected}}"></input-field>
					<paper-button raised on-tap="{{sendMessageInput}}" disabled?="{{!connected}}" flex>
						<core-icon class="big" icon="send"></core-icon>{{'chat.sendButton'|tr}}</paper-button>
				</simpl-row>
				<div id="messagesBox" role="status" aria-live="polite" aria-label="Chat log" aria-atomic="false" aria-busy="false" aria-relevant="additions">
					<template repeat="{{message in messages}}">
						<ol>
							<li>
								<template if="{{user.name == message.from}}">
									<div style="color:black;" class="name-column">{{ message.from }}</div>
								</template>
								<template if="{{user.name != message.from}}">
									<div style="color:#D50303;" class="name-column">{{ message.from }}</div>
								</template>
								<div class="message-column">{{ message.body }} </div>
							</li>
						</ol>
					</template>
				</div>
			</template>

			<template if="{{isAddUserFormActive}}">
				<h2>{{'chat.new_contact_header1'|tr}}</h2>
				<h4>{{'chat.new_contact_header2'|tr}}</h4>
				<simpl-form id="addUserForm" namespace="firstapp" actionCallback="{{addUserCallback}}" formName="chat_add_user.form"></simpl-form>
			</template>

			<template if="{{isAddGroupFormActive}}">
				<h2>{{'chat.new_group_header'|tr}}</h2>
				<simpl-form id="addGroupForm" namespace="firstapp" actionCallback="{{addGroupCallback}}" formName="chat_add_group.form"></simpl-form>
			</template>
		</simpl-panel>
	</template>
	<script>
		Polymer( "simpl-chat", {
			recvMessage: null,
			connected: false,
			isAddUserFormActive: false,
			isAddGroupFormActive: false,
			autoConnect: true,
			resourceId: null,
			pausingTimeout: 2500,
			messages: [],
			ready: function() {
				this.user = {
					name: "msa",
					password: "msa"
				};
				this.resourceId = getShortId();
				this.addUserCallback = this.addUser.bind( this );
				this.addGroupCallback = this.addGroup.bind( this );
				window.addEventListener( 'unload', ( function( e ) {
					if ( this.connected ) {
						this.sendChatState( "gone" );
					}
					done();
				} ).bind( this ) );
			},
			sendMessageInput: function() {
				var messageInput = this.shadowRoot.querySelector( "#messageInput" );
				var participant = this.shadowRoot.querySelector( "#participant" );
				if ( this.isEmpty( participant ) ) {
					console.error( "no participant selected" );
					return;
				}
				if ( messageInput.value != "" ) {
					var message = {
						body: messageInput.value,
						participant: $( participant ).val(),
						from: this.user.name
					};
					console.log( "<- sendMessage:", message );
					this.messages.unshift( message );
					this.$.websocket.sendMessage( message );
					messageInput.setValue( "" );
					this.sendChatState( "active" );
					this.isComposing = false;
				}
			},
			recvMessageChanged: function() {
				var message = this.recvMessage;
				console.log( "-> recvMessage", message );
				var body = message.body;
				var chatState = message.chatState;
				if ( message.from ) {
					message.from = message.from.split( "@" )[ 0 ];
				}
				if ( message.body ) {
					message.color = "green";
					this.messages.unshift( message );
				}
				if ( message.chatState ) {
					this.chatState = tr( 'chat.state_' + chatState );
				}
				if ( message.rosterEntries ) {
					this.rosterEntries = message.rosterEntries;
					this.rosterEntries.sort( this.sortRosterEntries );
				}
			},
			connect: function() {
				this.rosterEntries = [];
				this.$.websocket.go( this.user.name, this.user.password, this.resourceId );
			},
			disconnect: function() {
				this.sendChatState( "gone" );
				setTimeout( ( function() {
					this.$.websocket.closeConnection( this.user.name, this.user.password );
				} ).bind( this ), 300 );
			},
			connectedChanged: function() {
				this.isComposing = false;
				setTimeout( ( function() {
					if ( this.connected ) {
						this.messageInputElement = this.shadowRoot.querySelector( "#messageInput /deep/ #input" );
						$( this.messageInputElement ).on( 'focus', this.chatEventListener.bind( this ) );
						$( this.messageInputElement ).on( 'blur', this.chatEventListener.bind( this ) );
					} else {
						this.isComposing = false;
						$( this.messageInputElement ).off( 'focus', this.chatEventListener );
						$( this.messageInputElement ).off( 'blur', this.chatEventListener );
					}
				} ).bind( this ), 100 );
			},
			showAddUserForm: function() {
				this.isAddUserFormActive = true;
			},
			showAddGroupForm: function() {
				this.isAddGroupFormActive = true;
			},
			addUser: function( e ) {
				this.isAddUserFormActive = false;
				var addUserForm = this.shadowRoot.querySelector( "#addUserForm" );
				var formData = addUserForm.getData();
				if ( this.isEmpty( formData.username ) ) {
					return;
				}
				var message = {
					command: "addUser",
					parameter: {
						username: formData.username,
						nickname: formData.nickname
					}
				};
				this.$.websocket.sendMessage( message );
			},
			addGroup: function( e ) {
				this.isAddGroupFormActive = false;
				var addGroupForm = this.shadowRoot.querySelector( "#addGroupForm" );
				console.log( "addGroup:", addGroupForm.getData() );
				var formData = addUserForm.getData();
				if ( this.isEmpty( formData.groupname ) ) {
					return;
				}
				var message = {
					command: "addGroup",
					parameter: {
						username: formData.groupname,
					}
				};
				this.$.websocket.sendMessage( message );
			},
			onMessageKeydown: function( e ) {
				if ( e.keyCode && e.keyCode == 13 ) this.sendMessageInput();
			},
			chatEventListener: function( e ) {
				var type = e.type;
				if ( type == 'keyup' && e.keyCode != 13 ) {
					if ( $( this.messageInputElement ).val() && ( this.isComposing == false ) ) {
						this.isComposing = true;
						this.checkPausingTimeout = setTimeout( this.checkPausing.bind( this ), this.pausingTimeout );
						this.sendChatState( 'composing' );
					} else if ( !$( this.messageInputElement ).val() && ( this.isComposing == true ) ) {
						this.isComposing = false;
						this.sendChatState( 'active' );
					} else if ( $( this.messageInputElement ).val() && ( this.isComposing == true ) ) {
						clearTimeout( this.checkPausingTimeout );
						this.checkPausingTimeout = setTimeout( this.checkPausing.bind( this ), this.pausingTimeout );
					}
				}
				if ( type == 'focus' ) {
					if ( !$( this.messageInputElement ).val() ) {
						this.sendChatState( 'active' );
					} else {
						this.sendChatState( 'composing' );
					}
				}
				if ( type == 'blur' ) {
					this.sendChatState( 'inactive' );
				}
			},
			checkPausing: function() {
				if ( this.isComposing ) {
					this.sendChatState( "paused" );
					this.isComposing = false;
				}
			},
			sendChatState: function( state ) {
				var participant = $( this.shadowRoot.querySelector( "#participant" ) ).val();
				if ( this.isEmpty( participant ) ) {
					console.error( "no participant selected" );
					return;
				}
				var message = {
					command: "chatState",
					participant: participant,
					parameter: {
						state: state
					}
				};
				this.$.websocket.sendMessage( message );
			},
			sortRosterEntries: function compare( a, b ) {
				if ( a.username < b.username ){
					return -1;
				}
				if ( a.username > b.username ){
					return 1;
				}
				return 0;
			},
			isEmpty: function( s ) {
				if ( s == null || s == '' ) return true;
				return false;
			}
		} );

	</script>
</polymer-element>

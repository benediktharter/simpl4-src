<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<polymer-element name="simpl-chat">
	<template>
		<style>
			:host {
				display: block;
			}
			paper-button /deep/ .button-content {
				padding: 0.5em 0.5em;
			}
			paper-button {
				max-width: 100px;
			}
			simpl-form {
				width: 100%;
			}
			:host /deep/ xaction-button /deep/ .button-content {
				width: 120px;
				font-size: 12px;
				padding: 0.5em 0.5em;
			}
			simpl-row {
				margin-bottom: 12px;
			}
			core-icon.small {
				width: 16px;
				height: 16px;
			}
			core-icon.big {
				width: 24px;
				height: 24px;
			}
			simpl-panel /deep/ #panelContent {
				min-height: 400px;
				padding: 10px 5px 5px 5px !important;
			}
			.small-input {
				padding: 3px;
				margin-right: 2px;
				max-width: 50px;
				border-radius: 3px;
				border: 1px solid #CCC;
				background-image: none;
			}
			.name-column {
				float: left;
				width: 25%;
				padding: 2px;
			}
			.message-column {
				float: left;
				width: 60%;
				padding: 2px;
				word-wrap: break-word;
			}
			.timestamp-column {
				float: left;
				right: 0px;
				margin-right: 0px;
				text-align: center;
				font-size: 8px;
				font-weight: lighter;
				width: 15%;
				padding: 2px;
				background-color: #F2F2F2;
				color: gray;
			}
			#messagesBox {
				border: 0px solid black;
				overflow-y: auto;
				min-height: 100px;
				font-size: 12px;
			}
			ol {
				list-style: none;
				margin: 0px;
				padding: 0px;
			}
			li {
				float: left;
				display: inline;
				border-bottom: 1px solid #F2F2F2;
				width: 100%;
				height: 100%;
				padding-bottom: 0px;
			}
			core-toolbar.core-narrow /deep/ #topBar.toolbar-tools {
				align-items: baseline;
			}
			core-toolbar.core-narrow {
				height: 90px;
				background: #f6f6f6;
			}
			core-item {
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
			}
			paper-tab {
				z-index: 100;
				border-radius: 6px;
			}
			paper-tabs::shadow #selectionBar {
				background-color: black;
				//background: #d50303;
			}
			paper-tabs paper-tab::shadow #ink {
				opacity: .6;
				color: #d50303;
			}
			.dropdown.colored {
				border-radius: 3px;
				color: #000;
				//border: 1px solid #0f9d58;
				border: 1px solid #ccc;
				//background-color: #b7e1cd;
				background-color: #eee;
			}

		</style>


		<simpl-websocket id="websocket" namespace="global" routeSpec="xmpp.camel" service="xmpp" connected="{{connected}}" recvMessage="{{recvMessage}}" autoConnect="{{autoConnect}}"> </simpl-websocket>
		<simpl-panel bgcolor="black" heading="~ Simpl Chat" collapsable="true" collapsed="false">

			<core-animated-pages id="pages" selected="{{viewId}}" valueattr="view-id">
				<section view-id="loginView">
					<simpl-row>
						<simpl-form id="loginForm" namespace="global" data="{{loginData}}" actionCallback="{{loginCallback}}" formName="/forms/chat/login.form"></simpl-form>
					</simpl-row>
				</section>
				<section style="position:relative;" view-id="chatView">
					<simpl-row>
						<core-toolbar flex class="core-narrow">
							<core-icon-button on-tap="{{disconnect}}" icon="cloud-off"></core-icon-button>
							<core-icon-button icon="account-circle">{{loginData.username}}</core-icon-button>
							<core-menu-button>
								<core-icon-button icon="menu"></core-icon-button>
								<core-dropdown class="dropdown colored" layered="true">
									<core-menu>
										<core-item on-tap="{{showAddUserForm}}" icon="add">{{'chat.add_contact'|tr}}</core-item>
										<core-item on-tap="{{showAddGroupForm}}" icon="add-circle">{{'chat.add_group'|tr}}</core-item>
										<core-item on-tap="{{showRoomList}}" icon="content-copy">{{'chat.roomlist'|tr}}</core-item>
									</core-menu>
								</core-dropdown>
							</core-menu-button>

							<span style="color:#D50303;">{{chatState}}</span>
							<div class="bottom fit" horizontal layout>
								<paper-tabs selected="{{chatId}}" flex style="max-width:600px;" valueattr="chat-id" scrollable>
									<template repeat="{{chat, i in chatList}}">
										<paper-tab chat-id="{{chat.id}}">{{chat.id}}</paper-tab>
									</template>
								</paper-tabs>
							</div>
						</core-toolbar>
					</simpl-row>


					<core-animated-pages selected="{{chatId}}" valueattr="chat-id">
						<template repeat="{{chat, i in chatList}}">
							<section style="position:relative;" chat-id="{{chat.id}}">
								<template if="{{chat.muc == false}}">
									<simpl-row>
										{{'chat.participant'|tr}}:
										<select id="{{'participant-'+chat.id}}">
											<template repeat="{{entry in rosterEntries}}">
												<option value="{{entry.username}}">{{entry.username}}</option>
											</template>
										</select>
									</simpl-row>
								</template>
								<simpl-row>
									<input-field flex type="text" name="" id="{{'messageInput-'+chat.id}}" on-keyup="{{chatEventListener}}" on-keydown="{{onMessageKeydown}}" disabled?="{{!connected}}"></input-field>
									<paper-button raised on-tap="{{sendMessageInput}}" disabled?="{{!connected}}" flex>
										<core-icon class="big" icon="send"></core-icon>{{'chat.sendButton'|tr}}</paper-button>
								</simpl-row>
								<div id="messagesBox" role="status" aria-live="polite" aria-label="Chat log" aria-atomic="false" aria-busy="false" aria-relevant="additions">
									<template repeat="{{message in chat.messages}}">
										<ol>
											<li>
												<template if="{{loginData.username == message.from}}">
													<div style="color:black;" class="name-column">{{ message.from }}</div>
												</template>
												<template if="{{loginData.username != message.from}}">
													<div style="color:#D50303;" class="name-column">{{ message.from }}</div>
												</template>
												<div class="message-column">{{ message.body }} </div>
											</li>
										</ol>
									</template>
								</div>
							</section>
						</template>
					</core-animated-pages>
				</section>
				<section view-id="addUserView">
					<h2>{{'chat.new_contact_header1'|tr}}</h2>
					<h4>{{'chat.new_contact_header2'|tr}}</h4>
					<simpl-form id="addUserForm" namespace="global" actionCallback="{{addUserCallback}}" formName="/forms/chat/add_user.form"></simpl-form>
				</section>
				<section view-id="addGroupView">
					<h2>{{'chat.new_group_header'|tr}}</h2>
					<simpl-form id="addGroupForm" namespace="global" actionCallback="{{addGroupCallback}}" formName="/forms/chat/add_group.form"></simpl-form>
				</section>
				<section view-id="roomlistView">
					<simpl-form id="roomlistForm" namespace="global" actionCallback="{{joinRoomCallback}}" formName="/forms/chat/select_room.form"></simpl-form>
				</section>
			</core-animated-pages>

		</simpl-panel>
	</template>
	<script>
		Polymer( "simpl-chat", {
			chatId: 'main',
			viewId: "loginView",
			recvMessage: null,
			connected: false,
			autoConnect: true,
			resourceId: null,
			pausingTimeout: 2500,
			messages: [],
			ready: function() {
				this.resetChatList();
				this.loginData = {};
				this.resourceId = getShortId();
				this.addUserCallback = this.addUser.bind( this );
				this.addGroupCallback = this.addGroup.bind( this );
				this.loginCallback = this.login.bind( this );
				this.joinRoomCallback = this.joinRoom.bind( this );
				window.addEventListener( 'unload', ( function( e ) {
					if ( this.connected ) {
						this.sendChatState( "gone" );
					}
					done();
				} ).bind( this ) );
			},
			sendMessageInput: function() {
				var chat = this.chatHash[ this.chatId ];
				var messageInput = this.shadowRoot.querySelector( "#messageInput-" + chat.id );
				var participant = $( this.shadowRoot.querySelector( "#participant-" + chat.id ) ).val();
				if ( this.isEmpty( participant ) && chat.muc === false ) {
					console.error( "no participant selected" );
					return;
				}
				if ( messageInput.value != "" ) {
					var message = {
						body: messageInput.value,
						from: this.loginData.username
					};
					if ( !this.isEmpty( participant ) ) {
						message.participant = participant;
					}
					if ( chat.muc ) {
						message.room = chat.id;
					}
					chat.messages.unshift( message );
					this.$.websocket.sendMessage( message );
					messageInput.setValue( "" );
					this.sendChatState( "active" );
					this.isComposing = false;
				}
			},
			sendJoin: function( chat ) {
				if ( chat == null ) {
					chat = this.chatHash[ this.chatId ];
				}
				if ( chat.muc === false ) return;
				var message = {
					body: "",
					from: this.loginData.username,
					room: chat.id
				}
				this.$.websocket.sendMessage( message );
			},
			recvMessageChanged: function() {
				var message = this.recvMessage;
				console.log( "-> recvMessage", message );
				var chatState = message.chatState;
				if ( message.from ) {
					message.from = message.from.split( "@" )[ 0 ];
				}
				var chat = null;
				if ( message.type == "groupchat" ) {
					message.from = message.from.split( "@" )[ 0 ];
					chat = this.chatHash[ message.from ];
				} else if ( message.type == "chat" ) {
					chat = this.chatHash[ "main" ];
				}
				if ( !this.isEmpty( message.body ) ) {
					chat.messages.unshift( message );
				}
				if ( message.chatState ) {
					this.chatState = tr( 'chat.state_' + chatState );
				}
				if ( chat && chat.muc === true ) {
					this.chatState = '';
				}
				if ( message.rosterEntries ) {
					this.rosterEntries = message.rosterEntries;
					this.rosterEntries.sort( this.sortRosterEntries );
				}
			},
			login: function( e ) {
				var loginForm = this.shadowRoot.querySelector( "#loginForm" );
				var formData = loginForm.getData();
				console.log( "loginData:", formData );
				if ( this.isEmpty( formData.username ) ) {
					return;
				}
				if ( !this.isEmpty( formData.resource ) ) {
					this.resourceId = formData.resource;
				}

				this.loginData = formData;
				this.rosterEntries = [];
				this.chatId = 'main';
				this.resetChatList();
				this.$.websocket.go( formData.username, formData.password, this.resourceId, this.socketTimeoutCallback.bind( this ) );
			},
			disconnect: function() {
				this.sendChatState( "gone" );
				this.async( function() {
					this.$.websocket.closeConnection( this.loginData.username, this.loginData.password );
				}, null, 300 );
			},
			socketTimeoutCallback: function() {
				this.async( function() {
					var chat = this.chatHash[ this.chatId ];
					for ( var i = 0; i < this.chatList.length; i++ ) {
						var chat = this.chatList[ i ];
						if ( chat.muc ) {
							this.sendJoin( chat );
						}
					}
				}, null, 500 );
			},
			connectedChanged: function() {
				this.isComposing = false;
				this.async( function() {
					if ( this.connected ) {
						this.messageInputElement = this.shadowRoot.querySelector( "#messageInput /deep/ #input" );
						$( this.messageInputElement ).on( 'focus', this.chatEventListener.bind( this ) );
						$( this.messageInputElement ).on( 'blur', this.chatEventListener.bind( this ) );
						this.viewId = "chatView";
					} else {
						this.isComposing = false;
						$( this.messageInputElement ).off( 'focus', this.chatEventListener );
						$( this.messageInputElement ).off( 'blur', this.chatEventListener );
						this.viewId = "loginView";
					}
				}, null, 100 );
			},
			showRoomList: function() {
				this.viewId = "roomlistView";
				var params = {
					service: "xmpp",
					method: "getRooms",
					parameter: {
						serviceName: "conference"
					},
					async: true,
					context: this,
					failed: function( e ) {
						console.error( "showRoomList:", e );
					},
					completed: function( roomList ) {
						var rooms = [];
						for ( var i = 0; i < roomList.length; i++ ) {
							var room = {};
							room.name = roomList[ i ].name;
							room.description = roomList[ i ].description;
							rooms.push( room );
						}
						var items = {
							room: rooms
						};
						var roomlistForm = this.shadowRoot.querySelector( "#roomlistForm" );
						roomlistForm.setItems( items );
					}
				}
				simpl4.util.Rpc.rpcAsync( params );
			},
			joinRoom: function( e ) {
				var roomlistForm = this.shadowRoot.querySelector( "#roomlistForm" );
				var formData = roomlistForm.getData();
				console.log( "roomListData:", formData );

				this.viewId = "chatView";
				if ( e.target.xaction == "cancel" ) {
					 return;
				}
				if( formData.room == null){
					 return;
				}
				var chat = {};
				chat.id = formData.room[ 0 ].name;
				if( this.chatHash[chat.id]){
					return;
				}
				chat.messages = [];
				chat.muc = true;
				this.addChat( chat );
				this.chatId = chat.id;
				this.async( function() {
					this.sendJoin();
				}, null, 300 );
			},
			showAddUserForm: function() {
				this.viewId = "addUserView";
			},
			showAddGroupForm: function() {
				this.viewId = "addGroupView";
			},
			addUser: function( e ) {
				this.viewId = "chatView";
				var addUserForm = this.shadowRoot.querySelector( "#addUserForm" );
				var formData = addUserForm.getData();
				if ( this.isEmpty( formData.username ) ) {
					return;
				}
				var message = {
					command: "addUser",
					parameter: {
						username: formData.username,
						nickname: formData.nickname
					}
				};
				this.$.websocket.sendMessage( message );
			},
			addGroup: function( e ) {
				this.viewId = "chatView";
				var addGroupForm = this.shadowRoot.querySelector( "#addGroupForm" );
				console.log( "addGroup:", addGroupForm.getData() );
				var formData = addUserForm.getData();
				if ( this.isEmpty( formData.groupname ) ) {
					return;
				}
				var message = {
					command: "addGroup",
					parameter: {
						username: formData.groupname,
					}
				};
				this.$.websocket.sendMessage( message );
			},
			onMessageKeydown: function( e ) {
				if ( e.keyCode && e.keyCode == 13 ) this.sendMessageInput();
			},
			chatEventListener: function( e ) {
				var type = e.type;
				if ( type == 'keyup' && e.keyCode != 13 ) {
					if ( $( this.messageInputElement ).val() && ( this.isComposing == false ) ) {
						this.isComposing = true;
						this.checkPausingTimeout = setTimeout( this.checkPausing.bind( this ), this.pausingTimeout );
						this.sendChatState( 'composing' );
					} else if ( !$( this.messageInputElement ).val() && ( this.isComposing == true ) ) {
						this.isComposing = false;
						this.sendChatState( 'active' );
					} else if ( $( this.messageInputElement ).val() && ( this.isComposing == true ) ) {
						clearTimeout( this.checkPausingTimeout );
						this.checkPausingTimeout = setTimeout( this.checkPausing.bind( this ), this.pausingTimeout );
					}
				}
				if ( type == 'focus' ) {
					if ( !$( this.messageInputElement ).val() ) {
						this.sendChatState( 'active' );
					} else {
						this.sendChatState( 'composing' );
					}
				}
				if ( type == 'blur' ) {
					this.sendChatState( 'inactive' );
				}
			},
			checkPausing: function() {
				if ( this.isComposing ) {
					this.sendChatState( "paused" );
					this.isComposing = false;
				}
			},
			sendChatState: function( state ) {
				var chat = this.chatHash[ this.chatId ];
				var participant = $( this.shadowRoot.querySelector( "#participant-" + chat.id ) ).val();
				if ( this.isEmpty( participant ) ) {
					if ( chat.muc === false ) {
						console.error( "no participant selected" );
					}
					return;
				}
				var message = {
					command: "chatState",
					participant: participant,
					parameter: {
						state: state
					}
				};
				this.$.websocket.sendMessage( message );
			},
			sortRosterEntries: function compare( a, b ) {
				if ( a.username < b.username ) {
					return -1;
				}
				if ( a.username > b.username ) {
					return 1;
				}
				return 0;
			},
			resetChatList: function() {
				this.chatList = [];
				var chat = {
					id: 'main',
					messages: [],
					muc: false
				};
				this.addChat( chat );
			},
			addChat: function( chat ) {
				this.chatList.push( chat );
				this.chatHash = this.toHash( this.chatList );
			},
			toHash: function( list ) {
				var hash = {}
				for ( var i = 0; i < list.length; i++ ) {
					hash[ list[ i ].id ] = list[ i ];
				}
				return hash;
			},
			isEmpty: function( s ) {
				if ( s == null || s == '' ) return true;
				return false;
			}
		} );

	</script>
</polymer-element>

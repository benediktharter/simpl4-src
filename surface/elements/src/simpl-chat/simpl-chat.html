<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<polymer-element name="simpl-chat">
	<template>
		<style>
			:host {
				display: block;
			}
			paper-button /deep/ .button-content {
				padding: 0.5em 0.5em;
			}
			paper-button {
				max-width: 100px;
			}
			simpl-row {
				margin-bottom: 12px;
			}
			core-icon.small {
				width: 16px;
				height: 16px;
			}
			core-icon.big {
				width: 24px;
				height: 24px;
			}
			simpl-panel /deep/ #panelContent {
				min-height: 400px;
				padding: 10px 5px 5px 5px !important;
			}
			.small-input {
				padding: 3px;
				margin-right: 2px;
				max-width: 50px;
				border-radius: 3px;
				border: 1px solid #CCC;
				background-image: none;
			}
			.name-column {
				float: left;
				width: 25%;
				padding: 2px;
			}
			.message-column {
				float: left;
				width: 60%;
				padding: 2px;
				word-wrap: break-word;
			}
			.timestamp-column {
				float: left;
				right: 0px;
				margin-right: 0px;
				text-align: center;
				font-size: 8px;
				font-weight: lighter;
				width: 15%;
				padding: 2px;
				background-color: #F2F2F2;
				color: gray;
			}
			#messagesBox {
				border: 0px solid lightgray;
				overflow-y: auto;
				min-height: 100px;
				font-size: 12px;
			}
			ol {
				list-style: none;
				margin: 0px;
				padding: 0px;
			}
			li {
				float: left;
				display: inline;
				border-bottom: 1px solid #F2F2F2;
				width: 100%;
				height: 100%;
				padding-bottom: 0px;
			}

		</style>


		<simpl-websocket id="websocket" namespace="tutorials" routeSpec="xmpp.camel" service="xmpp" instanceId="{{user.name}}" connected="{{connected}}" recvMessage="{{recvMessage}}" sendMessage="{{sendMessage}}" autoConnect="{{autoConnect}}"> </simpl-websocket>
		<simpl-panel bgcolor="black" heading="~ Simpl Chat" collapsable="true" collapsed="false">
			<simpl-row>
				<template if="{{!connected}}">
					{{'chat.login'|tr}}:
					<input class="small-input" type="text" id="userName" value="{{user.name}}" /> {{'data.user.password'|tr}}:
					<input class="small-input" type="text" id="password" value="{{user.password}}" />
					<paper-button raised on-tap="{{connect}}" flex>
						<core-icon class="small" icon="communication:chat"></core-icon>{{'chat.connectButton'|tr}}</paper-button>
				</template>
			</simpl-row>
			<template if="{{connected}}">
				<simpl-row>
					<paper-button raised on-tap="{{disconnect}}" style="margin-right:25px;">
						<core-icon class="small" icon="communication:clear-all"></core-icon>{{'chat.disconnectButton'|tr}}</paper-button>
					{{'chat.state'|tr}}: <span style="color:red;">{{chatState}}</span>
				</simpl-row>
				<simpl-row>
					{{'chat.participant'|tr}}:
					<select id="participant">
						<option value="guest@simpl4.org">Guest</option>
						<option value="msa@simpl4.org">msa</option>
						<option value="msa2@simpl4.org">msa2</option>
					</select>
				</simpl-row>
				<simpl-row>
					<input-field flex type="text" name="" id="messageInput" on-keydown="{{onMessageKeydown}}" disabled?="{{!connected}}"></input-field>
					<paper-button raised on-tap="{{send}}" disabled?="{{!connected}}" flex>
						<core-icon class="big" icon="send"></core-icon>{{'chat.sendButton'|tr}}</paper-button>
				</simpl-row>
				<div id="messagesBox" role="status" aria-live="polite" aria-label="Chat log" aria-atomic="false" aria-busy="false" aria-relevant="additions">
					<template repeat="{{message in messages}}">
						<ol>
							<li>
								<template if="{{user.name == message.from}}">
									<div style="color:black;" class="name-column">{{ message.from }}</div>
								</template>
								<template if="{{user.name != message.from}}">
									<div style="color:#D50303;" class="name-column">{{ message.from }}</div>
								</template>
								<div class="message-column">{{ message.body }} </div>
							</li>
						</ol>
					</template>
				</div>
			</template>
		</simpl-panel>
	</template>
	<script>
		Polymer( "simpl-chat", {
			recvMessage: null,
			sendMessage: null,
			connected: false,
			autoConnect: true,
			messages: [],
			ready: function() {
				this.user = {
					name: "msa",
					password: "msa",
					color: "#ff0000"
				};
			},
			send: function() {
				var messageInput = this.shadowRoot.querySelector( "#messageInput" );
				var participant = this.shadowRoot.querySelector( "#participant" );
				if ( messageInput.value != "" ) {
					var message = {
						body: messageInput.value,
						participant: $( participant ).val(),
						from: this.user.name
					};
					console.log( "sendMessage:", message );
					this.messages.unshift( message );
					this.sendMessage = message;
					messageInput.setValue( "" );
				}
				this.scrollToBottom();
			},
			onMessageKeydown: function( event ) {
				console.log( "onMessageKeydown" );
				if ( event.keyCode && event.keyCode == 13 ) this.send();
			},
			sendMessageChanged: function() {
				console.log( "sendMessageChanged changed" );
			},
			recvMessageChanged: function() {
				var message = this.recvMessage;
				var body = message.body;
				var chatState = message.chatState;
				if ( message.from ) {
					message.from = message.from.split( "@" )[ 0 ];
				}
				if ( message.body ) {
					message.color = "green";
					this.messages.unshift( message );
				}
				if ( message.chatState ) {
					this.chatState = chatState;
				}
				this.scrollToBottom();
			},
			connect: function() {
				console.log( "connect" );
				this.$.websocket.go( this.user.name, this.user.password );
			},
			disconnect: function() {
				console.log( "disconnect" );
				this.$.websocket.closeConnection( this.user.name, this.user.password );
			},
			connectedChanged: function() {
				console.log( "chat:connected changed", this.connected );
			},
			scrollToBottom: function() {
				var self = this;
				setTimeout( function() {
					var messagesBox = this.shadowRoot.querySelector( "#messagesBox" );
					if ( messagesBox && messagesBox.scrollTop != undefined && messagesBox.scrollHeight != undefined ) {
						messagesBox.scrollTop = messagesBox.scrollHeight;
					}
				}, 100 );
			}
		} );

	</script>
</polymer-element>

<!--
/**
 * This file is part of SIMPL4(http://simpl4.org).
 *
 * 	Copyright [2014] [Manfred Sattler] <manfred@ms123.org>
 *
 * SIMPL4 is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * SIMPL4 is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with SIMPL4.  If not, see <http://www.gnu.org/licenses/>.
 */
-->
<polymer-element name="simpl-websocket2" attributes="connected sendMessage recvMessage json jsonSend jsonReceive" constructor="SimplWebsocket2">
	<template>
		<style>
			:host {
				display: none;
			}

		</style>
	</template>
	<script type="text/javascript">
		( function() {
			Polymer( "simpl-websocket2", {
			publish: {
				connected: {
					value: false,
					reflect: true
				}
			},
				connected:false,
				/**
				 * Should both sent and received data be interpreted as json and encoded/decoded ? Defaults to false.
				 * @public
				 * @type {Boolean}
				 */
				json: true,
				/**
				 * Should sent data be json-encoded, even if {{json}} is falsy ? Defaults to false.
				 * @public
				 * @type {Boolean}
				 */
				jsonSend: false,
				/**
				 * Should received data be json-decoded, even if {{json}} is falsy ? Defaults to false.
				 * @type {Boolean}
				 */
				jsonReceive: false,
				/**
				 * WebSocket object.
				 * @private
				 * @type {WebSocket}
				 */
				ws: null,
				send: function( data ) {
					if ( !this.connected ) {
						throw new Error( "simpl-websocket2.send(...): not connected." );
					}
					if ( this.json || this.jsonSend ) {
						data = JSON.stringify( data );
					}
console.log("ws:send:",data);
					this.ws.send( data );
				},
				sendPing: function(  ) {
					if( !this.connected) return;
					console.debug("Ping");
					var message = {
						event: "ping",
						data: {}
					};
					this.send(message);
				},
				sendMessageChanged:function(){
					this.send(this.sendMessage);
				},
				close: function( reason ) {
					if ( this.ws ) {
						this.ws.close( reason );
						this.ws = null;
					}
					this.connected=false;
				},
				/**
				 * Underlying connection readyState getter.
				 * @see {@link http://www.w3.org/TR/websockets/#dom-websocket-readystate}
				 * @public
				 * @type {Number}
				 */
				get readyState() {
					if ( this.ws ) {
						return this.ws.readyState;
					} else {
						return -1;
					}
				},
				ready: function() {
					var password = simpl4.util.BaseManager.getPassword();
					var username = simpl4.util.BaseManager.getUser();
					var credentials = simpl4.util.Base64.encode( username + ":" + password );
					var uuid = this.generateUUID();
					var baseUrl = simpl4.util.BaseManager.getBaseUrl();
					baseUrl = baseUrl.replace("http", "ws");
					console.log("baseUrl:"+baseUrl);
					this.url = baseUrl + "/ws/xyz?service=xmpp&credentials=" + credentials+"&uuid="+uuid;
					console.log("url:"+this.url);
					this.wsConnect();
				},

				wsConnect: function() {
					if ( this.ws ) {
						//throw new Error( "simpl-websocket2.connect(...): already connected." );
					}


					this.ws = new ReconnectingWebSocket( this.url, null, { debug: false, reconnectInterval: 50 } 
																			);
					this.ws.onopen = this.onOpen.bind( this );
					this.ws.onerror = this.onError.bind( this );
					this.ws.onmessage = this.onMessage.bind( this );
					this.ws.onclose = this.onClose.bind( this );

					setInterval((function(){ this.sendPing(); }).bind(this), 3000);


				},
				onOpen: function(event) {
					console.log("onOpen", event);
					this.connected=true;
					this.fire( "open" );
				},

				onError: function(e) {
					console.log("OnError", e);
					this.fire( "error" );
				},

				onMessage: function( event ) {
					var data = event.data;
					if ( this.json || this.jsonReceive ) {
						data = JSON.parse( data );
					}
					this.fire( "message", {
						data: data
					} );
					this.recvMessage = data;
				},

				onClose: function( event ) {
					console.log("Onclose", event);
					this.fire( "error", {
						code: event.code,
						reason: event.reason
					} );
					this.connected=false;
					//this.wsConnect();
				},
				generateUUID: function() {
					var d = new Date().getTime();
					var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace( /[xy]/g, function( c ) {
						var r = ( d + Math.random() * 16 ) % 16 | 0;
						d = Math.floor( d / 16 );
						return ( c == 'x' ? r : ( r & 0x3 | 0x8 ) ).toString( 16 );
					} );
					return uuid;
				}
			} );
		} )();

	</script>
</polymer-element>
